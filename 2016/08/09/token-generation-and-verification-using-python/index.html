<!DOCTYPE html><html lang="en,zh-cn,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Wechat Official Account's Token Generation and Verification Using Python · Infinite.ft的博客</title><meta name="description" content="Wechat Official Account's Token Generation and Verification Using Python - infinite.ft"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://free-free.github.io/atom.xml" title="Infinite.ft的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/categories/math" target="_self" class="nav-list-link">MATH</a></li><li class="nav-list-item"><a href="/categories/tech" target="_self" class="nav-list-link">TECH</a></li><li class="nav-list-item"><a href="/categories/mylife" target="_self" class="nav-list-link">NOTES</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Wechat Official Account's Token Generation and Verification Using Python</h1><div class="post-info">Aug 9, 2016</div><div class="post-content"><h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h3><blockquote>
<p>最近在做微信公众号开发在进行网页授权时，微信需要用户自己在授权url中带上一个类似token的<strong>state</strong>的参数，以防止跨站攻击。<br>在经过再三思考之后，自己试着实现一个产生token和验证token的方案。接下就把code贴出来。希望读者指导一下。</p>
</blockquote>
<h3 id="2-产生token"><a href="#2-产生token" class="headerlink" title="2.产生token"></a>2.产生token</h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理:"></a>原理:</h4><blockquote>
<p>通过hmac sha1 算法产生用户给定的key和token的最大过期时间戳的一个消息摘要，<br>将这个消息摘要和最大过期时间戳通过”:”拼接起来，再进行base64编码，生成最终的token</p>
</blockquote>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现:"></a>实现:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> base64</div><div class="line"><span class="keyword">import</span> hmac</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_token</span><span class="params">(key, expire=<span class="number">3600</span>)</span>:</span></div><div class="line">    <span class="string">r'''</span></div><div class="line"><span class="string">        @Args:</span></div><div class="line"><span class="string">            key: str (用户给定的key，需要用户保存以便之后验证token,每次产生token时的key 都可以是同一个key)</span></div><div class="line"><span class="string">            expire: int(最大有效时间，单位为s)</span></div><div class="line"><span class="string">        @Return:</span></div><div class="line"><span class="string">            state: str</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    ts_str = str(time.time() + expire)</div><div class="line">    ts_byte = ts_str.encode(<span class="string">"utf-8"</span>)</div><div class="line">    sha1_tshexstr  = hmac.new(key.encode(<span class="string">"utf-8"</span>),ts_byte,<span class="string">'sha1'</span>).hexdigest() </div><div class="line">    token = ts_str+<span class="string">':'</span>+sha1_tshexstr</div><div class="line">    b64_token = base64.urlsafe_b64encode(token.encode(<span class="string">"utf-8"</span>))</div><div class="line">    <span class="keyword">return</span> b64_token.decode(<span class="string">"utf-8"</span>)</div></pre></td></tr></table></figure>
<h3 id="3-验证token"><a href="#3-验证token" class="headerlink" title="3.验证token"></a>3.验证token</h3><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理:"></a>原理:</h4><blockquote>
<p>将token进行base64解码,通过token得到token最大过期时间戳和消息摘要。判断token是否过期。<br>如没过期才将 从token中的取得最大过期时间戳进行hmac sha1 算法运算(<strong>注意这里的key要与产生token的key要相同</strong>)，<br>最后将产生的摘要与通过token取得消息摘要进行对比， 如果两个摘要相等，则token有效，否则token无效 。</p>
</blockquote>
<h4 id="实现："><a href="#实现：" class="headerlink" title="实现："></a>实现：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> base64</div><div class="line"><span class="keyword">import</span> hmac</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">certify_token</span><span class="params">(key, token)</span>:</span></div><div class="line">    <span class="string">r'''</span></div><div class="line"><span class="string">        @Args:</span></div><div class="line"><span class="string">            key: str</span></div><div class="line"><span class="string">            token: str</span></div><div class="line"><span class="string">        @Returns:</span></div><div class="line"><span class="string">            boolean</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    token_str = base64.urlsafe_b64decode(state).decode(<span class="string">'utf-8'</span>)</div><div class="line">    token_list = token_str.split(<span class="string">':'</span>)</div><div class="line">    <span class="keyword">if</span> len(token_list) != <span class="number">2</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    ts_str = token_list[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> float(ts_str) &lt; time.time():</div><div class="line">        <span class="comment"># token expired</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    known_sha1_tsstr = token_list[<span class="number">1</span>]</div><div class="line">    sha1 = hmac.new(key.encode(<span class="string">"utf-8"</span>),ts_str.encode(<span class="string">'utf-8'</span>),<span class="string">'sha1'</span>)</div><div class="line">    calc_sha1_tsstr = sha1.hexdigest()</div><div class="line">    <span class="keyword">if</span> calc_sha1_tsstr != known_sha1_tsstr:</div><div class="line">        <span class="comment"># token certification failed</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span> </div><div class="line">    <span class="comment"># token certification success</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<h3 id="4-用法"><a href="#4-用法" class="headerlink" title="4.用法"></a>4.用法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">key  = <span class="string">"JD98Dskw=23njQndW9D"</span></div><div class="line"><span class="comment"># 一小时后过期</span></div><div class="line">token = generate_token(key, <span class="number">3600</span>)</div><div class="line"></div><div class="line">certify_token(key, token)</div></pre></td></tr></table></figure>
<h3 id="5-Note"><a href="#5-Note" class="headerlink" title="5.Note!!!"></a>5.Note!!!</h3><blockquote>
<p>本代码只能在python3.x 中运行，</p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/15/say-hello/" class="prev">PREV</a><a href="/2016/03/12/aiomysql-insertion-operation-failed/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="https://free-free.github.io">infinite.ft</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>