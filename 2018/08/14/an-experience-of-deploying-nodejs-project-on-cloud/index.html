<!DOCTYPE html><html lang="en,zh-cn,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 记一次Nodejs项目在云上的部署过程 · Infinite.ft的博客</title><meta name="description" content="记一次Nodejs项目在云上的部署过程 - infinite.ft"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://free-free.github.io/atom.xml" title="Infinite.ft的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/categories/math" target="_self" class="nav-list-link">MATH</a></li><li class="nav-list-item"><a href="/categories/tech" target="_self" class="nav-list-link">TECH</a></li><li class="nav-list-item"><a href="/categories/mylife" target="_self" class="nav-list-link">NOTES</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">记一次Nodejs项目在云上的部署过程</h1><div class="post-info">Aug 14, 2018</div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>自读了这个研究生后，写的代码就越来越来少，天天和理论打交道， 搞自己有点神情恍惚，怀疑人生。不巧的是，最近老师有一个项目可以让自己温习一下曾经写代码时的激情岁月，至于此项目是干啥的，在这里就不详谈了，咱只关注所用到的技术栈，前端使用<code>vue</code>+<code>element-ui</code>+<code>vue-router</code>，后端<code>mongodb</code>+<code>nodejs</code>+<code>nginx</code>  + <code>pm2</code>由于之前一直没有在云上部署过nodejs相关的项目，这次借此机会来游走一下全程，一路上风景肆意，惊心动魄，可谓蔚为壮观也。近日心血来潮，遂在博客上记录下此过程，以便他日他人有所参考，既是功德一件。</p>
<p>在正式开始之前先讲一讲所用到技术在此此项目中的角色。</p>
<ul>
<li><p><code>vue</code></p>
<p><a href="https://vuejs.org/" target="_blank" rel="external">vue</a>就不用多说了，响应式的前端框架，和<a href="https://reactjs.org/" target="_blank" rel="external">React</a>和<a href="https://docs.angularjs.org/" target="_blank" rel="external">Angularjs</a>是一类东西，在此项目中用于构建前端界面。之所以选用vue，是因为vue相比其他前端框架，上手快，轻量化一点。</p>
</li>
<li><p><code>element-ui</code></p>
<p><a href="http://element-cn.eleme.io/#/" target="_blank" rel="external">element-ui</a>是适用于vue的前端UI框架，除此之外还可以用于React和Angularjs。<code>element-ui</code>提供了常用的前端UI控件。在项目使用它的好处也很明显，很多控件不用自己从头开始，开发效率会提升很多。</p>
</li>
<li><p><code>vue-router</code></p>
<p>负责<code>vue</code>的路由控制，是开发<code>SPA(Single Page Application)</code>不可少的，<code>SPA</code>的例子可以参看一下网易云音乐的网页版。</p>
</li>
<li><p><code>mongodb</code></p>
<p>作为后端数据储存服务，想过使用<code>mysql</code> ，但考虑到项目的变化比较大，果断选择<code>mongodb</code>。</p>
</li>
<li><p><code>nodejs</code></p>
<p>后端服务的主要开发语言，全程异步模式开启，还是有点爽，而且部署相比与<code>Python</code>要简单一点。缺点就是回调hell，让我有点措手不及。</p>
</li>
<li><p><code>nginx</code></p>
<p><code>nginx</code>在此项目中主要有两个作用。</p>
<p>作用一：前端Vue构建之后，全部是静态页面，使用<code>nginx</code>作为静态文件伺服器；</p>
<p>作用二：反向代理，将前端的API请求转发到<code>nodejs</code>后端服务上去。</p>
</li>
<li><p><code>pm2</code></p>
<p>pm2 是一个带有负载均衡功能的Nodejs应用进程管理器.当你要把你的独立代码利用全部的服务器上的所有CPU,并保证进程永远都活着,0秒的重载。此项目中使用<code>pm2</code>来管理后端的<code>nodejs</code>服务。</p>
</li>
</ul>
<h3 id="前端构建"><a href="#前端构建" class="headerlink" title="前端构建"></a>前端构建</h3><h4 id="build过程"><a href="#build过程" class="headerlink" title="build过程"></a>build过程</h4><p>项目中使用vue-cli来初始化的代码，vue-cli会自动把构建工具<code>webpack</code>和构建脚本创建好，需要build的时候，只需要在shell项目目录下输入下面命令即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm run build</div></pre></td></tr></table></figure>
<p>执行上面命令之后，build好的静态文件会放在<code>dist</code>目录下，将该目录下的所有文件copy到你的<code>nginx</code> root 目录下即可（上传到服务推荐使用scp，感觉不错）。虽然过程简单，但是构建过程中还是遇到一些问题。</p>
<h4 id="build过程遇到问题"><a href="#build过程遇到问题" class="headerlink" title="build过程遇到问题"></a>build过程遇到问题</h4><p><strong><code>一、问题一：vendor.js文件多大</code></strong></p>
<p>执行build命令之后，提示<code>vendor.js</code>文件过大，达到了800+KB。开始感觉800+KB对于现在的网络速度应该不大大，强行上传到服务器运行。一运行，发现被打脸了，首屏加载时间达到了4s+。这速度连我自己都忍受不了，还是果断想法优化<code>vendor.js</code>。</p>
<p><strong><code>问题一解决办法</code></strong></p>
<p><code>vendor.js</code>之所以那么大，原因在于打包的时候，会将项目中<code>import</code> 的<code>vue</code> 、<code>vue-router</code> 、 <code>element-ui</code>和<code>axios</code>一起打包到<code>vendor.js</code>中。查了官网和其他资料之后，针对<code>vendor.js</code>过大导致加载速度慢的解决办法大致有下面四种：</p>
<ol>
<li>在打包的时候，将<code>vendor.js</code>分成多个文件打包，具体可参见<a href="https://segmentfault.com/q/1010000008832754" target="_blank" rel="external">here</a> 。</li>
<li>使用vue路由懒加载，这样的话不用一次性将<code>vendor.js</code>的所有内容都下载到客户端，而是根据当前路由所需要组件，从后端拉取相应的部分，路由懒加载可参见<a href="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html#把组件按组分块" target="_blank" rel="external">官网</a> ，<a href="https://blog.csdn.net/qq_37540004/article/details/78727063" target="_blank" rel="external">文章1</a> ，<a href="https://www.cnblogs.com/zhanyishu/p/6587571.html" target="_blank" rel="external">文章2</a> 。</li>
<li>使用外部加载，将<code>vue</code> 、<code>vue-router</code> 、<code>element-ui</code> 和<code>axios</code>使用cdn引入，这样<code>vendor.js</code>将大大减小，浏览器访问时，能够开多个连接同时下载<code>vue</code> 、<code>vue-router</code> 、<code>element-ui</code> 和<code>axios</code> ，速度提升是可想而知。</li>
<li>使用SSR(服务端渲染)，使用SSR可选用<a href="https://nuxtjs.org/" target="_blank" rel="external">nuxt.js</a> ，具体可参见<a href="https://cn.vuejs.org/v2/guide/ssr.html" target="_blank" rel="external">这里</a> 。讲真，我开始天真的想要使用<code>nuxt.js</code> ，但参看了官网之后，我放弃了，有点不明觉厉官网在讲神马，叹息一声，自己能力不够呀。还有对于此项目，也没有必须要使用SSR。</li>
</ol>
<p>上述四种方法，各有各的优缺点，<code>方法1</code>和<code>方法3</code>都试图将<code>vendor.js</code>减小分成多个文件，充分利用浏览器的多连接下载，提高加载速度；<code>方法3</code>则将<code>vendor.js</code>里面的内容按需下载，不需要一次性下载全部内容，提高首次加载速度；<code>方法4</code>直接在服务端将页面渲染出来，这样即能提高加载速度，又有益于SEO优化，但难度确实有点大，建议新手不要去打击自己的信心。</p>
<p>最终自己选用相对简单一点的<code>方法3</code> ，其过程如下：</p>
<ol>
<li><p>在项目<code>build</code>目录下的<code>webpack.base.conf.js</code>文件中加入下面配置项：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">externals:&#123;</div><div class="line">  <span class="string">'vue'</span>:<span class="string">'Vue'</span>,</div><div class="line">  <span class="string">'element-ui'</span>:<span class="string">'ElementUI'</span>,</div><div class="line">  <span class="string">'axios'</span>:<span class="string">'axios'</span>,</div><div class="line">  <span class="string">'vue-router'</span>:<span class="string">"VueRouter"</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>其中配置项的<code>key</code>为需要外部加载的库名称，<code>value</code>为需要从库中引入的对象名称，该对象作为全局对象的暴露给其他文件，等效于在<code>js</code>文件中使用<code>import</code>引入库中的对象，上述配置即等价于下面内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</div><div class="line"><span class="keyword">import</span> ElementUI <span class="keyword">from</span> <span class="string">'element-ui'</span>;</div><div class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</div><div class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">'vue-router'</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>在项目根目录下<code>index.html</code>，添加各个库对应的cdn链接</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>cnki swust<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vue/2.5.16/vue.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vue-router/3.0.1/vue-router.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/axios/0.18.0/axios.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/element-ui/2.4.0/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- built files will be auto injected --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>不要将cdn链接错误的放到<code>body</code>后面，不然导致vuejs不能找到外部引入的对象。</p>
</li>
<li><p>在<code>main.js</code>和其他通过<code>import</code>引入<code>vue</code> 、<code>vue-router</code> 、<code>element-ui</code> 和<code>axios</code>对象的文件中，删除对应的<code>import</code>代码，并把<code>main.js</code>中 <code>Vue.use(VueRouter)</code>和<code>Vue.use(ElementUI)</code>语句删掉。</p>
</li>
<li><p>重新<code>build</code> ， 你会奇迹的发现<code>vendor.js</code>只有90+KB大小了。恩，好，不错地。第一问题算是解决了。</p>
<p>如果你觉得你的<code>vendor.js</code>文件开始有点大，可以开启压缩模式，在项目<code>config</code>目录下的<code>index.js</code>文件中使能下面选项：</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// npm install --save-dev compression-webpack-plugin</span></div><div class="line">  productionGzip: <span class="literal">true</span>,</div><div class="line">  productionGzipExtensions: [<span class="string">'js'</span>, <span class="string">'css'</span>],</div></pre></td></tr></table></figure>
<p>并执行下面命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --save-dev compression-webpack-plugin</div></pre></td></tr></table></figure>
<p>完成上面过程后，再次<code>build</code>，你会发现<code>build</code>结果中会多出与<code>css</code>和<code>js</code>文件同名，以<code>gz</code>结尾的文件，前端加载时会优先加载这些压缩文件，进一步提高页面下载速度。</p>
<p><strong><code>二、问题二：ERROR from static/js/vendor.js from UglifyJS Unexpected Token ....</code></strong></p>
<p>在<code>build</code>的时候，总是出现上述错误，原因在于UglifyJs不能识别ES6语法。针对此问题有两种解决方法</p>
<ol>
<li><p>使用<code>babel-loader</code>将含有ES6语法的文件转换一下，再使用UglifyJs进行压缩。</p>
<p>只需要打开<code>build/webpack.base.conf.js</code>文件，在<code>module&gt;rules&gt;babel-loader</code>对应的配置项对应的<code>include</code>字段中添加中含有ES6语法文件的所在目录即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  test: <span class="regexp">/\.js$/</span>,</div><div class="line">    loader: <span class="string">'babel-loader'</span>,</div><div class="line">      include: [</div><div class="line">        resolve(<span class="string">'src'</span>), </div><div class="line">        resolve(<span class="string">'test'</span>),</div><div class="line">        resolve(<span class="string">'exmaple-dir'</span>)</div><div class="line">      ]</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
</li>
<li><p>使用<code>babili-webpack-plugin</code>插件替代<code>UglifyJs</code></p>
<p>安装插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install babili-wepback-plugin --save-dev </div><div class="line">npm install babel-core@6.21.0</div></pre></td></tr></table></figure>
<p>在<code>build/webpack.prod.conf.js</code>文件的<code>pulgins</code>配置项使用<code>babili-webpack-plugin</code>替换<code>UglifyJs</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">plugins: [</div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">  new webpack.optimize.UglifyJsPlugin(&#123;</span></div><div class="line"><span class="comment">        compress: &#123;</span></div><div class="line"><span class="comment">          warnings: false</span></div><div class="line"><span class="comment">        &#125;,</span></div><div class="line"><span class="comment">        sourceMap: true</span></div><div class="line"><span class="comment">  &#125;)</span></div><div class="line"><span class="comment">  */</span></div><div class="line">  <span class="keyword">new</span> <span class="built_in">require</span>(<span class="string">'babili-webpack-plugin'</span>)() </div><div class="line">],</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>
<h3 id="后端环境搭建"><a href="#后端环境搭建" class="headerlink" title="后端环境搭建"></a>后端环境搭建</h3><h4 id="1-云服务选择"><a href="#1-云服务选择" class="headerlink" title="1. 云服务选择"></a>1. 云服务选择</h4><p>之前一直选用阿里云，这一次想试一下腾讯云。以前服务器操作系统选用的CentOS，这一次选用Ubuntu。腾讯云最近在搞活动，学生认证之后，<code>10RMB</code>就可以买到<code>1CPU+2G Mem+40G Disk</code> ，而且还有50G对象储存服务，感谢腾讯云对教育的支持（鼓掌）。当然阿里云也有学生认证服务器，传说中的云翼计划，也是<code>10RMB</code>=<code>1CPU+2G Mem+ 40G SSD</code> ，不过没有50G的对象储存服务，还是小马家要富裕一点(抠鼻)。不管怎样，都感谢两家公司对教育的支持。</p>
<h4 id="2-安装Nodejs"><a href="#2-安装Nodejs" class="headerlink" title="2.  安装Nodejs"></a>2.  安装Nodejs</h4><ul>
<li><p>使用<code>apt</code>安装nodejs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install nodejs-legacy</div></pre></td></tr></table></figure>
<p>安装之后发现nodejs版本太老了，才4.6.0，果断自己下载安装</p>
</li>
<li><p>下载安装nodejs(推荐)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">wget https://npm.taobao.org/mirrors/node/v10.8.0/node-v10.8.0-linux-x64.tar.xz</div><div class="line">tar -xvf node-v10.8.0-linux-x64.tar.xz</div><div class="line">mv node nodejs</div><div class="line">sudo mv nodejs /opt/ <span class="comment"># 安装到/opt目录下</span></div><div class="line"><span class="built_in">echo</span> -e <span class="string">'PATH=$PATH:/opt/nodejs/bin\nexport PATH'</span> &gt;&gt; ~/.bashrc <span class="comment"># 添加到环境变量</span></div><div class="line"><span class="built_in">source</span> ~/.bashrc</div><div class="line"><span class="comment"># 安装nvm</span></div><div class="line">wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="3-安装和配置nginx"><a href="#3-安装和配置nginx" class="headerlink" title="3. 安装和配置nginx"></a>3. 安装和配置nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install nginx</div></pre></td></tr></table></figure>
<p>通过apt安装的nginx版本为1.10.3，版本还比较新，可以直接使用。nginx在本项目中主要作为前端静态文件伺服和后端服务的反代理，维持需要进行一定配置，配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">user www-data;</div><div class="line">worker_processes auto;</div><div class="line">pid /run/nginx.pid;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">	worker_connections 1024;</div><div class="line">	<span class="comment"># multi_accept on;</span></div><div class="line">	use epoll;</div><div class="line">&#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line"></div><div class="line">	log_format main <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">                        <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">			<span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</div><div class="line">	<span class="comment">##</span></div><div class="line">	<span class="comment"># Basic Settings</span></div><div class="line">	<span class="comment">##</span></div><div class="line"></div><div class="line">	sendfile on;</div><div class="line">	tcp_nopush on;</div><div class="line">	tcp_nodelay on;</div><div class="line">	keepalive_timeout 65;</div><div class="line">	types_hash_max_size 2048;</div><div class="line">	fastcgi_intercept_errors on;</div><div class="line">	<span class="comment"># server_tokens off;</span></div><div class="line"></div><div class="line">	<span class="comment"># server_names_hash_bucket_size 64;</span></div><div class="line">	<span class="comment"># server_name_in_redirect off;</span></div><div class="line"></div><div class="line">	include /etc/nginx/mime.types;</div><div class="line">	default_type application/octet-stream;</div><div class="line"></div><div class="line">	<span class="comment">##</span></div><div class="line">	<span class="comment"># SSL Settings</span></div><div class="line">	<span class="comment">##</span></div><div class="line"></div><div class="line">	ssl_protocols TLSv1 TLSv1.1 TLSv1.2; <span class="comment"># Dropping SSLv3, ref: POODLE</span></div><div class="line">	ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line">	<span class="comment">##</span></div><div class="line">	<span class="comment"># Logging Settings</span></div><div class="line">	<span class="comment">##</span></div><div class="line"></div><div class="line">	access_log /var/<span class="built_in">log</span>/nginx/access.log;</div><div class="line">	error_log /var/<span class="built_in">log</span>/nginx/error.log;</div><div class="line"></div><div class="line">	<span class="comment">##</span></div><div class="line">	<span class="comment"># Gzip Settings</span></div><div class="line">	<span class="comment">##</span></div><div class="line"></div><div class="line">	gzip on;</div><div class="line">	gzip_disable <span class="string">"msie6"</span>;</div><div class="line"></div><div class="line">	<span class="comment"># gzip_vary on;</span></div><div class="line">	<span class="comment"># gzip_proxied any;</span></div><div class="line">	<span class="comment"># gzip_comp_level 6;</span></div><div class="line">	<span class="comment"># gzip_buffers 16 8k;</span></div><div class="line">	<span class="comment"># gzip_http_version 1.1;</span></div><div class="line">	<span class="comment"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span></div><div class="line"></div><div class="line">	<span class="comment">##</span></div><div class="line">	<span class="comment"># Virtual Host Configs</span></div><div class="line">	<span class="comment">##</span></div><div class="line">	upstream back-server&#123;</div><div class="line">	    server 127.0.0.1:3000;</div><div class="line">	    server 127.0.0.1:3001;</div><div class="line">	&#125;</div><div class="line">	server&#123;</div><div class="line">	    listen 80;</div><div class="line">        server_name www.xyz.com;</div><div class="line">        <span class="comment">#存放前端静态文件</span></div><div class="line">	    root /var/www/xyz/;</div><div class="line">	    index index.html;</div><div class="line">	    <span class="comment"># 将404页面重定向到index.html</span></div><div class="line">	    try_files <span class="variable">$uri</span> /index.html = 404;</div><div class="line">	    <span class="comment"># 反向代理，将API请求转发到后端服务</span></div><div class="line">	    location /api/ &#123;</div><div class="line">                proxy_set_header Cookie <span class="variable">$http_cookie</span>;</div><div class="line">                proxy_set_header Host <span class="variable">$http_host</span>;</div><div class="line">                proxy_redirect off;</div><div class="line">                proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">                proxy_set_header X-Scheme <span class="variable">$scheme</span>;</div><div class="line">                proxy_pass http://back-server;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	include /etc/nginx/conf.d/*.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置完成后，重启nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart nginx</div><div class="line">sudo systemctl <span class="built_in">enable</span> nginx <span class="comment"># 开机启动nginx</span></div></pre></td></tr></table></figure>
<h4 id="4-安装和配置mongodb"><a href="#4-安装和配置mongodb" class="headerlink" title="4.安装和配置mongodb"></a>4.安装和配置mongodb</h4><ul>
<li><p>使用<code>apt</code>安装mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install mongodb</div></pre></td></tr></table></figure>
<p>安装之后发现mongodb版本为2.6.0，版本太老了，mongodb最新版本已经到了3.6.x，还是选用其他安装方法吧。</p>
</li>
<li><p>手动添加mongodb源安装(使用阿里源)[推荐]</p>
<ol>
<li><p>导入阿里源的公钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2930ADAE8CAF5059EE73BB4B58712A2291FA4AD5</div></pre></td></tr></table></figure>
</li>
<li><p>添加源文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"deb [ arch=amd64,arm64 ] http://mirrors.aliyun.com/mongodb/apt/ubuntu xenial/mongodb-org/3.6 multiverse"</span> | sudo tee /etc/apt/sources.list.d/mongodb-org-3.6.list</div></pre></td></tr></table></figure>
</li>
<li><p>安装最新mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt update</div><div class="line">sudo apt install mongodb-org</div></pre></td></tr></table></figure>
</li>
</ol>
<p>安装完成，对mongodb进行如下配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mongod.conf</span></div><div class="line"></div><div class="line"><span class="comment"># for documentation of all options, see:</span></div><div class="line"><span class="comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span></div><div class="line"></div><div class="line"><span class="comment"># Where and how to store data.</span></div><div class="line"><span class="attr">storage:</span></div><div class="line"><span class="attr">  dbPath:</span> <span class="string">/var/lib/mongodb</span></div><div class="line"><span class="attr">  journal:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="comment">#  engine:</span></div><div class="line"><span class="comment">#  mmapv1:</span></div><div class="line"><span class="comment">#  wiredTiger:</span></div><div class="line"></div><div class="line"><span class="comment"># where to write logging data.</span></div><div class="line"><span class="attr">systemLog:</span></div><div class="line"><span class="attr">  destination:</span> <span class="string">file</span></div><div class="line"><span class="attr">  logAppend:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  path:</span> <span class="string">/var/log/mongodb/mongod.log</span></div><div class="line"></div><div class="line"><span class="comment"># network interfaces</span></div><div class="line"><span class="attr">net:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">27017</span></div><div class="line">  <span class="comment"># 绑定到本地ip</span></div><div class="line"><span class="attr">  bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># how the process runs</span></div><div class="line"><span class="attr">processManagement:</span></div><div class="line"><span class="attr">  timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></div><div class="line"></div><div class="line"><span class="comment">#security:</span></div><div class="line"></div><div class="line"><span class="comment">#operationProfiling:</span></div><div class="line"></div><div class="line"><span class="comment">#replication:</span></div><div class="line"></div><div class="line"><span class="comment">#sharding:</span></div><div class="line"></div><div class="line"><span class="comment">## Enterprise-Only Options:</span></div><div class="line"></div><div class="line"><span class="comment">#auditLog:</span></div><div class="line"></div><div class="line"><span class="comment">#snmp:</span></div></pre></td></tr></table></figure>
<p>项目中数据量不大，不需要考虑分片和复制集的配置，如果需要专业的，建议使用云数据库，省去很多数据库运维的麻烦。</p>
<p>重启mongodb</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart mongod</div><div class="line">sudo systemctl <span class="built_in">enable</span> mongod <span class="comment"># 开机启动mongodb</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5-安装pm2"><a href="#5-安装pm2" class="headerlink" title="5. 安装pm2"></a>5. 安装pm2</h4><p>常用的进程管理器有supervisor、pm2和forever，在本项目中，选用功能较为强大的pm2。pm2负责管理后端的nodejs服务。</p>
<p><code>安装</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i pm2 -g</div></pre></td></tr></table></figure>
<p><code>使用pm2启动后端服务</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pm2 start ./bin/www -i 2 --name=<span class="string">"api"</span> <span class="comment">#启动两个后端服务实例</span></div><div class="line">pm2 startup <span class="comment"># 开启启动</span></div></pre></td></tr></table></figure>
<p>详细的pm2命令请查看<a href="http://pm2.keymetrics.io/" target="_blank" rel="external">这里</a></p>
<h3 id="结术语"><a href="#结术语" class="headerlink" title="结术语"></a>结术语</h3><p>至此，一个nodejs项目云上部署过程已经完成，部署过程中并没有考虑到监考和报警之类的功能，在未来的日子再考虑吧。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/18/install-chrome-and-firefox-on-ubuntu16-04/" class="prev">PREV</a><a href="/2018/08/12/compile-and-install-python3-5-on-raspberrypi/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://free-free.github.io">infinite.ft</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>